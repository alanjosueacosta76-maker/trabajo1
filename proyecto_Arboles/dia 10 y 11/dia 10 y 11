// program.cs modificado  para las pruebas de los dias
using ProyectoArboles;

class Program
{
    static void Main()
    {
        // === PARA EJECUTAR LA CONSOLA ===
        // Arbol arbol = new Arbol();
        // Trie trie = new Trie();
        // Consola consola = new Consola(arbol, trie);
        // consola.Iniciar();

        // === PARA EJECUTAR LAS PRUEBAS DE INTEGRACIÓN ===
        PruebasIntegracion.Ejecutar();
    }
}

//archivo PruebasIntegracion.cs creado para las pruebas del dia 10 y 11
using System;
using ProyectoArboles;
using System.Diagnostics;

public class PruebasIntegracion
{
    public static void Ejecutar()
    {
        Console.WriteLine("=== DÍA 10–11: PRUEBAS DE INTEGRACIÓN Y PERFORMANCE ===");

        Arbol arbol = new Arbol();
        Trie trie = new Trie();

        // 1) PRUEBA DE CREACIÓN MASIVA
        Console.WriteLine("\n--- Prueba 1: Crear 5,000 archivos ---");

        Stopwatch sw = Stopwatch.StartNew();

        for (int i = 0; i < 5000; i++)
        {
            string nombre = "archivo_" + i + ".txt";
            arbol.Insertar("/", nombre, "archivo", "contenido...");
            trie.Insertar(nombre, arbol.Buscar("/" + nombre));
        }

        sw.Stop();
        Console.WriteLine($"Tiempo: {sw.ElapsedMilliseconds} ms");
        Console.WriteLine($"Tamaño total del árbol: {arbol.Tamano()}");

        // 2) PRUEBA DE AUTOCOMPLETADO
        Console.WriteLine("\n--- Prueba 2: Autocompletado ---");

        var resultados = trie.Autocompletar("archivo_49");

        Console.WriteLine($"Resultados: {resultados.Count}");
        foreach (var r in resultados)
        {
            Console.WriteLine("  " + r);
        }

        // 3) PRUEBA DE GUARDAR Y CARGAR JSON CON ÁRBOL GRANDE
        Console.WriteLine("\n--- Prueba 3: Guardar y cargar JSON ---");

        string archivo = "arbol_masivo.json";

        sw.Restart();
        arbol.GuardarJSON(archivo);
        sw.Stop();

        Console.WriteLine($"Guardado en {sw.ElapsedMilliseconds} ms");

        sw.Restart();
        Arbol nuevo = new Arbol();
        nuevo.CargarJSON(archivo);
        sw.Stop();

        Console.WriteLine($"Cargado en {sw.ElapsedMilliseconds} ms");
        Console.WriteLine($"Tamaño cargado: {nuevo.Tamano()}");

        // 4) CASOS LÍMITE
        Console.WriteLine("\n--- Prueba 4: Casos límite ---");

        Console.WriteLine("Intentar eliminar raíz:");
        arbol.Eliminar("/");

        Console.WriteLine("Intentar cd a carpeta inexistente:");
        Console.WriteLine(arbol.Buscar("/NoExiste") == null ? "Correcto." : "Error.");

        Console.WriteLine("Prueba terminada.");
    }
}


//archivo arbol.cs sin modificaciones por estos dias
using System;
using System.Collections.Generic;
using System.Text.Json;
using System.IO;

namespace ProyectoArboles
{
    public class Arbol
    {
        public Nodo Raiz { get; set; }
        private Trie trie; // ← Estructura para autocompletado y búsqueda (Día 5–6)

        public Arbol()
        {
            Raiz = new Nodo("/", "carpeta");
            trie = new Trie();
            trie.Insertar(Raiz.Nombre, Raiz); // Indexar raíz
        }

        //  BÚSQUEDA POR RUTA
        public Nodo? Buscar(string ruta)
        {
            if (ruta == "/" || ruta == "")
                return Raiz;

            string[] partes = ruta.Trim('/').Split('/');
            Nodo actual = Raiz;

            foreach (var parte in partes)
            {
                Nodo? encontrado = actual.Children.Find(h => h.Nombre == parte);
                if (encontrado == null)
                {
                    Console.WriteLine("Ruta no encontrada: " + ruta);
                    return null;
                }
                actual = encontrado;
            }
            return actual;
        }

        //  INSERTAR (actualiza TRIE)
        public bool Insertar(string rutaPadre, string nombre, string tipo, string? contenido = null)
        {
            Nodo? padre = Buscar(rutaPadre);
            if (padre == null)
            {
                Console.WriteLine("No se pudo insertar: la ruta padre no existe.");
                return false;
            }

            if (!padre.EsCarpeta())
            {
                Console.WriteLine("No se puede insertar dentro de un archivo.");
                return false;
            }

            if (padre.Children.Exists(n => n.Nombre == nombre))
            {
                Console.WriteLine("Ya existe un nodo con ese nombre.");
                return false;
            }

            Nodo nuevo = new Nodo(nombre, tipo, contenido);
            padre.AgregarHijo(nuevo);

            trie.Insertar(nombre, nuevo); // INDEXAR EN TRIE

            Console.WriteLine("Insertado correctamente: " + nombre);
            return true;
        }

        //  ELIMINAR (actualiza TRIE)
        public bool Eliminar(string ruta)
        {
            Nodo? nodo = Buscar(ruta);

            if (nodo == null)
            {
                Console.WriteLine("No se puede eliminar: ruta no encontrada.");
                return false;
            }

            if (nodo == Raiz)
            {
                Console.WriteLine("No se puede eliminar la raíz.");
                return false;
            }

            nodo.Padre!.EliminarHijo(nodo);

            trie.Eliminar(nodo.Nombre, nodo); // QUITAR DE TRIE

            Console.WriteLine("Nodo eliminado: " + ruta);
            return true;
        }

        //  MOVER (actualiza TRIE INDIRECTAMENTE)
        public bool Mover(string origen, string destino)
        {
            Nodo? nodo = Buscar(origen);
            Nodo? destinoNodo = Buscar(destino);

            if (nodo == null || destinoNodo == null)
            {
                Console.WriteLine("No se puede mover: ruta inválida.");
                return false;
            }

            if (!destinoNodo.EsCarpeta())
            {
                Console.WriteLine("No se puede mover dentro de un archivo.");
                return false;
            }

            nodo.Padre!.EliminarHijo(nodo);
            destinoNodo.AgregarHijo(nodo);

            Console.WriteLine($"Nodo movido: {origen} -> {destino}");
            return true;
        }



        public bool Renombrar(string ruta, string nuevoNombre)
        {
            Nodo? nodo = Buscar(ruta);

            if (nodo == null)
            {
                Console.WriteLine("No se puede renombrar: ruta inválida.");
                return false;
            }

            if (nodo == Raiz)
            {
                Console.WriteLine("No se puede renombrar la raíz.");
                return false;
            }

            if (nodo.Padre!.Children.Exists(h => h.Nombre == nuevoNombre))
            {
                Console.WriteLine("Ya existe un nodo con ese nombre.");
                return false;
            }

            trie.Eliminar(nodo.Nombre, nodo);  // quitar viejo nombre
            nodo.Nombre = nuevoNombre;
            trie.Insertar(nuevoNombre, nodo);  // indexar nuevo nombre

            Console.WriteLine($"Renombrado correctamente: {ruta} -> {nuevoNombre}");
            return true;
        }

        //  TAMAÑO Y ALTURA
        public int Tamano() => Contar(Raiz);

        private int Contar(Nodo nodo)
        {
            int total = 1;
            foreach (var hijo in nodo.Children)
                total += Contar(hijo);
            return total;
        }

        public int Altura() => AlturaRec(Raiz);

        private int AlturaRec(Nodo nodo)
        {
            if (nodo.Children.Count == 0)
                return 1;

            int max = 0;
            foreach (var hijo in nodo.Children)
                max = Math.Max(max, AlturaRec(hijo));

            return 1 + max;
        }

        //  DÍA 5–6: BÚSQUEDA POR NOMBRE + AUTOCOMPLETADO
        public List<Nodo> BuscarNombre(string nombre)
        {
            return trie.BusquedaExacta(nombre);
        }

        public List<Nodo> Autocompletar(string prefijo)
        {
            return trie.Autocompletar(prefijo);
        }

        //       PERSISTENCIA JSON (DÍA 4)
        public void GuardarJSON(string rutaArchivo)
        {
            var opciones = new JsonSerializerOptions
            {
                WriteIndented = true
            };

            string json = JsonSerializer.Serialize(Raiz, opciones);
            File.WriteAllText(rutaArchivo, json);

            Console.WriteLine("Árbol guardado en JSON correctamente.");
        }

        public void CargarJSON(string rutaArchivo)
        {
            if (!File.Exists(rutaArchivo))
            {
                Console.WriteLine("No se encontró el archivo JSON.");
                return;
            }

            string json = File.ReadAllText(rutaArchivo);
            Nodo? nuevaRaiz = JsonSerializer.Deserialize<Nodo>(json);

            if (nuevaRaiz == null)
            {
                Console.WriteLine("Error al cargar el árbol desde JSON.");
                return;
            }

            this.Raiz = nuevaRaiz;

            ReasignarPadres(Raiz, null);

            // RECONSTRUIR TRIE COMPLETO DESDE EL ÁRBOL
            trie = new Trie();
            ReIndexarTrie(Raiz);

            Console.WriteLine("Árbol cargado correctamente desde JSON.");
        }

        private void ReIndexarTrie(Nodo nodo)
        {
            trie.Insertar(nodo.Nombre, nodo);

            foreach (var hijo in nodo.Children)
                ReIndexarTrie(hijo);
        }

        private void ReasignarPadres(Nodo nodo, Nodo? padre)
        {
            nodo.Padre = padre;

            foreach (var hijo in nodo.Children)
                ReasignarPadres(hijo, nodo);
        }
    }
}

//archivo nodo.cs sin modificaciones por este dia
using System;
using System.Collections.Generic;
using System.Text.Json.Serialization;   

namespace ProyectoArboles
{
    public class Nodo
    {
        public string Id { get; set; }
        public string Nombre { get; set; }
        public string Tipo { get; set; }
        public string Contenido { get; set; }
        public List<Nodo> Children { get; set; }

        [JsonIgnore]  //evita ciclos
        public Nodo Padre { get; set; }

        public Nodo(string nombre, string tipo, string contenido = null, Nodo padre = null)
        {
            Id = Guid.NewGuid().ToString();
            Nombre = nombre;
            Tipo = tipo;
            Contenido = contenido;
            Children = new List<Nodo>();
            Padre = padre;
        }

        public override string ToString()
        {
            return $"<{Tipo.ToUpper()}: {Nombre} (ID: {Id.Substring(0, 8)})>";
        }

        public void AgregarHijo(Nodo hijo)
        {
            hijo.Padre = this;
            Children.Add(hijo);
        }

        public bool EliminarHijo(Nodo hijo)
        {
            if (Children.Contains(hijo))
            {
                Children.Remove(hijo);
                hijo.Padre = null;
                return true;
            }
            return false;
        }

        public bool EsCarpeta()
        {
            return Tipo == "carpeta";
        }
    }
}

//archivo trie.cs 
using System;
using System.Collections.Generic;

namespace ProyectoArboles
{
    public class TrieNodo
    {
        public Dictionary<char, TrieNodo> Hijos = new Dictionary<char, TrieNodo>();
        public List<Nodo> Referencias = new List<Nodo>(); 
    }

    public class Trie
    {
        private TrieNodo raiz = new TrieNodo();

        // INSERTAR NOMBRE EN EL TRIE
        public void Insertar(string palabra, Nodo nodo)
        {
            TrieNodo actual = raiz;

            foreach (char c in palabra.ToLower())
            {
                if (!actual.Hijos.ContainsKey(c))
                    actual.Hijos[c] = new TrieNodo();

                actual = actual.Hijos[c];
            }

            actual.Referencias.Add(nodo);
        }

        // ELIMINAR UNA REFERENCIA (NO BORRA SUBÁRBOLES)
        public void Eliminar(string palabra, Nodo nodo)
        {
            TrieNodo actual = raiz;

            foreach (char c in palabra.ToLower())
            {
                if (!actual.Hijos.ContainsKey(c))
                    return; // No existe, nada que eliminar

                actual = actual.Hijos[c];
            }

            actual.Referencias.Remove(nodo);
        }

        // BÚSQUEDA EXACTA
        public List<Nodo> BusquedaExacta(string palabra)
        {
            TrieNodo actual = raiz;

            foreach (char c in palabra.ToLower())
            {
                if (!actual.Hijos.ContainsKey(c))
                    return new List<Nodo>(); // No existe

                actual = actual.Hijos[c];
            }

            return new List<Nodo>(actual.Referencias);
        }

        // AUTOCOMPLETADO       
        public List<Nodo> Autocompletar(string prefijo)
        {
            TrieNodo actual = raiz;

            foreach (char c in prefijo.ToLower())
            {
                if (!actual.Hijos.ContainsKey(c))
                    return new List<Nodo>();

                actual = actual.Hijos[c];
            }

            List<Nodo> resultados = new List<Nodo>();
            RecolectarNodos(actual, resultados);
            return resultados;
        }

        private void RecolectarNodos(TrieNodo nodo, List<Nodo> lista)
        {
            lista.AddRange(nodo.Referencias);

            foreach (var hijo in nodo.Hijos.Values)
                RecolectarNodos(hijo, lista);
        }
    }
}
