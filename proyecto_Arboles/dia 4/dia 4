// archivo nodo.cs recibio algunos cambios ya no guarda  el nodo padre para evitar ciclos innecesarios
using System;
using System.Collections.Generic;
using System.Text.Json.Serialization;

namespace ProyectoArboles
{
    public class Nodo
    {
        public string Id { get; set; }
        public string Nombre { get; set; }
        public string Tipo { get; set; }
        public string Contenido { get; set; }
        public List<Nodo> Children { get; set; }

        [JsonIgnore]  // <-- Evita ciclos al serializar
        public Nodo Padre { get; set; }

        public Nodo(string nombre, string tipo, string contenido = null, Nodo padre = null)
        {
            Id = Guid.NewGuid().ToString();
            Nombre = nombre;
            Tipo = tipo;
            Contenido = contenido;
            Children = new List<Nodo>();
            Padre = padre;
        }

        public override string ToString()
        {
            return $"<{Tipo.ToUpper()}: {Nombre} (ID: {Id.Substring(0, 8)})>";
        }

        public void AgregarHijo(Nodo hijo)
        {
            hijo.Padre = this;
            Children.Add(hijo);
        }

        public bool EliminarHijo(Nodo hijo)
        {
            if (Children.Contains(hijo))
            {
                Children.Remove(hijo);
                hijo.Padre = null;
                return true;
            }
            return false;
        }

        public bool EsCarpeta()
        {
            return Tipo == "carpeta";
        }
    }
}

//archivo Arbol.cs cambios metodo guardarjson, cargarjson, reasignar padres
using System;
using System.Collections.Generic;
using System.Text.Json;
using System.IO;

namespace ProyectoArboles
{
    public class Arbol
    {
        public Nodo Raiz { get; set; }

        public Arbol()
        {
            Raiz = new Nodo("/", "carpeta");
        }

        public Nodo? Buscar(string ruta)
        {
            if (ruta == "/" || ruta == "")
                return Raiz;

            string[] partes = ruta.Trim('/').Split('/');
            Nodo actual = Raiz;

            foreach (var parte in partes)
            {
                Nodo? encontrado = actual.Children.Find(h => h.Nombre == parte);
                if (encontrado == null)
                {
                    Console.WriteLine("Ruta no encontrada: " + ruta);
                    return null;
                }
                actual = encontrado;
            }
            return actual;
        }

        public bool Insertar(string rutaPadre, string nombre, string tipo, string? contenido = null)
        {
            Nodo? padre = Buscar(rutaPadre);
            if (padre == null)
            {
                Console.WriteLine("No se pudo insertar: la ruta padre no existe.");
                return false;
            }

            if (!padre.EsCarpeta())
            {
                Console.WriteLine("No se puede insertar dentro de un archivo.");
                return false;
            }

            if (padre.Children.Exists(n => n.Nombre == nombre))
            {
                Console.WriteLine("Ya existe un nodo con ese nombre.");
                return false;
            }

            Nodo nuevo = new Nodo(nombre, tipo, contenido);
            padre.AgregarHijo(nuevo);

            Console.WriteLine("Insertado correctamente: " + nombre);
            return true;
        }

        public bool Eliminar(string ruta)
        {
            Nodo? nodo = Buscar(ruta);

            if (nodo == null)
            {
                Console.WriteLine("No se puede eliminar: ruta no encontrada.");
                return false;
            }

            if (nodo == Raiz)
            {
                Console.WriteLine("No se puede eliminar la raíz.");
                return false;
            }

            nodo.Padre!.EliminarHijo(nodo);

            Console.WriteLine("Nodo eliminado: " + ruta);
            return true;
        }

        public bool Mover(string origen, string destino)
        {
            Nodo? nodo = Buscar(origen);
            Nodo? destinoNodo = Buscar(destino);

            if (nodo == null || destinoNodo == null)
            {
                Console.WriteLine("No se puede mover: ruta inválida.");
                return false;
            }

            if (!destinoNodo.EsCarpeta())
            {
                Console.WriteLine("No se puede mover dentro de un archivo.");
                return false;
            }

            nodo.Padre!.EliminarHijo(nodo);
            destinoNodo.AgregarHijo(nodo);

            Console.WriteLine($"Nodo movido: {origen} -> {destino}");
            return true;
        }

        public bool Renombrar(string ruta, string nuevoNombre)
        {
            Nodo? nodo = Buscar(ruta);

            if (nodo == null)
            {
                Console.WriteLine("No se puede renombrar: ruta inválida.");
                return false;
            }

            if (nodo == Raiz)
            {
                Console.WriteLine("No se puede renombrar la raíz.");
                return false;
            }

            if (nodo.Padre!.Children.Exists(h => h.Nombre == nuevoNombre))
            {
                Console.WriteLine("Ya existe un nodo con ese nombre.");
                return false;
            }

            nodo.Nombre = nuevoNombre;

            Console.WriteLine($"Renombrado correctamente: {ruta} -> {nuevoNombre}");

            return true;
        }

        public int Tamano()
        {
            return Contar(Raiz);
        }

        private int Contar(Nodo nodo)
        {
            int total = 1;

            foreach (var hijo in nodo.Children)
                total += Contar(hijo);

            return total;
        }

        public int Altura()
        {
            return AlturaRec(Raiz);
        }

        private int AlturaRec(Nodo nodo)
        {
            if (nodo.Children.Count == 0)
                return 1;

            int max = 0;

            foreach (var hijo in nodo.Children)
                max = Math.Max(max, AlturaRec(hijo));

            return 1 + max;
        }

        //              DÍA 4: JSON

        public void GuardarJSON(string rutaArchivo)
        {
            var opciones = new JsonSerializerOptions
            {
                WriteIndented = true
            };

            string json = JsonSerializer.Serialize(Raiz, opciones);
            File.WriteAllText(rutaArchivo, json);

            Console.WriteLine("Árbol guardado en JSON correctamente.");
        }

        public void CargarJSON(string rutaArchivo)
        {
            if (!File.Exists(rutaArchivo))
            {
                Console.WriteLine("No se encontró el archivo JSON.");
                return;
            }

            string json = File.ReadAllText(rutaArchivo);
            Nodo? nuevaRaiz = JsonSerializer.Deserialize<Nodo>(json);

            if (nuevaRaiz == null)
            {
                Console.WriteLine("Error al cargar el árbol desde JSON.");
                return;
            }

            this.Raiz = nuevaRaiz;

            ReasignarPadres(Raiz, null);
            Console.WriteLine("Árbol cargado correctamente desde JSON.");
        }

        private void ReasignarPadres(Nodo nodo, Nodo? padre)
        {
            nodo.Padre = padre;

            foreach (var hijo in nodo.Children)
                ReasignarPadres(hijo, nodo);
        }
    }
}

//archivo pruebas.cs respectivas pruebas del  dia 4
using System;
using ProyectoArboles;

public static class PruebasDia4
{
    public static void Ejecutar()
    {
        Console.WriteLine("=== PRUEBA DÍA 4: GUARDAR / CARGAR JSON ===\n");

        var arbol = new Arbol();

        arbol.Insertar("/", "Documentos", "carpeta");
        arbol.Insertar("/Documentos", "Tarea1.txt", "archivo", "Contenido de prueba");
        arbol.Insertar("/", "Imagenes", "carpeta");

        Console.WriteLine("\nGuardando el árbol en JSON...");
        arbol.GuardarJSON("arbol.json");

        Console.WriteLine("\nCreando árbol vacío y cargando JSON...");
        var arbol2 = new Arbol();
        arbol2.CargarJSON("arbol.json");

        Console.WriteLine($"Tamaño del árbol cargado: {arbol2.Tamano()}");
    }
}

//archivo program.cs 
using ProyectoArboles;

class Program
{
    static void Main()
    {
        Arbol fs = new Arbol();

        fs.Insertar("/", "Documentos", "carpeta");
        fs.Insertar("/Documentos", "Tarea1.txt", "archivo");
        fs.Insertar("/", "Imagenes", "carpeta");

        Console.WriteLine("Guardando el árbol en JSON...");
        fs.GuardarJSON("arbol.json");

        Console.WriteLine("\nCreando árbol vacío y cargando JSON...");
        Arbol fs2 = new Arbol();
        fs2.CargarJSON("arbol.json");

        Console.WriteLine("Tamaño del árbol cargado: " + fs2.Tamano());
    }
}
