// Nuevo archivo consola.cs 
using System;
using System.Collections.Generic;

namespace ProyectoArboles
{
    public class Consola
    {
        private Arbol arbol;
        private Nodo directorioActual;
        private List<Nodo> papelera = new List<Nodo>();

        public Consola(Arbol arbol)
        {
            this.arbol = arbol;
            this.directorioActual = arbol.Raiz;
        }

        public void Iniciar()
        {
            Console.WriteLine("=== EXPLORADOR DE ARCHIVOS ===\n");

            while (true)
            {
                Console.Write($"{ObtenerRutaActual()}> ");
                string? comando = Console.ReadLine();

                if (string.IsNullOrWhiteSpace(comando))
                    continue;

                ProcesarComando(comando.Trim());
            }
        }

        // Obtiene la ruta actual en formato /Carpeta/Subcarpeta
        private string ObtenerRutaActual()
        {
            List<string> partes = new List<string>();
            Nodo actual = directorioActual;

            while (actual != null)
            {
                partes.Insert(0, actual.Nombre);
                actual = actual.Padre;
            }

            return string.Join("/", partes);
        }

        // Procesador central de comandos tipo shell
        private void ProcesarComando(string linea)
        {
            string[] partes = linea.Split(' ', 2);
            string comando = partes[0].ToLower();
            string argumento = partes.Length > 1 ? partes[1] : "";

            switch (comando)
            {
                case "ls": Listar(); break;
                case "cd": CambiarDirectorio(argumento); break;
                case "mkdir": CrearCarpeta(argumento); break;
                case "touch": CrearArchivo(argumento); break;
                case "rename": Renombrar(argumento); break;
                case "mv": Mover(argumento); break;
                case "rm": Eliminar(argumento); break;
                case "trash": MostrarPapelera(); break;
                case "restore": Restaurar(argumento); break;
                case "empty": VaciarPapelera(); break;
                case "find": Buscar(argumento); break;
                case "auto": Autocompletar(argumento); break;
                case "exit": Environment.Exit(0); break;
                default:
                    Console.WriteLine("Comando no reconocido.");
                    break;
            }
        }

        // Implementación de comandos
        private void Listar()
        {
            foreach (var h in directorioActual.Children)
                Console.WriteLine(h);
        }

        private void CambiarDirectorio(string nombre)
        {
            if (nombre == "..")
            {
                if (directorioActual.Padre != null)
                    directorioActual = directorioActual.Padre;
                return;
            }

            var destino = directorioActual.Children.Find(h => h.Nombre == nombre && h.EsCarpeta());

            if (destino == null)
            {
                Console.WriteLine("Carpeta no encontrada.");
                return;
            }

            directorioActual = destino;
        }

        private void CrearCarpeta(string nombre)
        {
            arbol.Insertar(ObtenerRutaActual(), nombre, "carpeta");
        }

        private void CrearArchivo(string nombre)
        {
            arbol.Insertar(ObtenerRutaActual(), nombre, "archivo");
        }

        private void Renombrar(string args)
        {
            string[] p = args.Split(' ');
            if (p.Length != 2)
            {
                Console.WriteLine("Uso: rename viejo nuevo");
                return;
            }

            string ruta = ObtenerRutaActual() + "/" + p[0];
            arbol.Renombrar(ruta, p[1]);
        }

        private void Mover(string args)
        {
            string[] p = args.Split(' ');
            if (p.Length != 2)
            {
                Console.WriteLine("Uso: mv origen destino");
                return;
            }

            string origen = ObtenerRutaActual() + "/" + p[0];
            string destino = ObtenerRutaActual() + "/" + p[1];

            arbol.Mover(origen, destino);
        }

        private void Eliminar(string nombre)
        {
            string ruta = ObtenerRutaActual() + "/" + nombre;
            Nodo? nodo = arbol.Buscar(ruta);

            if (nodo == null)
            {
                Console.WriteLine("No existe el archivo.");
                return;
            }

            papelera.Add(nodo);
            arbol.Eliminar(ruta);

            Console.WriteLine($"Movido a papelera: {nombre}");
        }

        private void MostrarPapelera()
        {
            Console.WriteLine("=== PAPELERA ===");
            foreach (var n in papelera)
                Console.WriteLine(n);
        }

        private void Restaurar(string nombre)
        {
            var nodo = papelera.Find(n => n.Nombre == nombre);

            if (nodo == null)
            {
                Console.WriteLine("No está en la papelera.");
                return;
            }

            papelera.Remove(nodo);
            directorioActual.AgregarHijo(nodo);

            Console.WriteLine("Restaurado.");
        }

        private void VaciarPapelera()
        {
            papelera.Clear();
            Console.WriteLine("Papelera vaciada.");
        }

        private void Buscar(string nombre)
        {
            var resultados = arbol.BuscarNombre(nombre);
            foreach (var r in resultados)
                Console.WriteLine("Encontrado: " + r);
        }

        private void Autocompletar(string prefijo)
        {
            var resultados = arbol.Autocompletar(prefijo);
            foreach (var r in resultados)
                Console.WriteLine("Coincidencia: " + r);
        }
    }
}

// archivo arbol.cs sin ningun cambio
using System;
using System.Collections.Generic;
using System.Text.Json;
using System.IO;

namespace ProyectoArboles
{
    public class Arbol
    {
        public Nodo Raiz { get; set; }
        private Trie trie; // ← Estructura para autocompletado y búsqueda (Día 5–6)

        public Arbol()
        {
            Raiz = new Nodo("/", "carpeta");
            trie = new Trie();
            trie.Insertar(Raiz.Nombre, Raiz); // Indexar raíz
        }

        //  BÚSQUEDA POR RUTA
        public Nodo? Buscar(string ruta)
        {
            if (ruta == "/" || ruta == "")
                return Raiz;

            string[] partes = ruta.Trim('/').Split('/');
            Nodo actual = Raiz;

            foreach (var parte in partes)
            {
                Nodo? encontrado = actual.Children.Find(h => h.Nombre == parte);
                if (encontrado == null)
                {
                    Console.WriteLine("Ruta no encontrada: " + ruta);
                    return null;
                }
                actual = encontrado;
            }
            return actual;
        }

        //  INSERTAR (actualiza TRIE)
        public bool Insertar(string rutaPadre, string nombre, string tipo, string? contenido = null)
        {
            Nodo? padre = Buscar(rutaPadre);
            if (padre == null)
            {
                Console.WriteLine("No se pudo insertar: la ruta padre no existe.");
                return false;
            }

            if (!padre.EsCarpeta())
            {
                Console.WriteLine("No se puede insertar dentro de un archivo.");
                return false;
            }

            if (padre.Children.Exists(n => n.Nombre == nombre))
            {
                Console.WriteLine("Ya existe un nodo con ese nombre.");
                return false;
            }

            Nodo nuevo = new Nodo(nombre, tipo, contenido);
            padre.AgregarHijo(nuevo);

            trie.Insertar(nombre, nuevo); // INDEXAR EN TRIE

            Console.WriteLine("Insertado correctamente: " + nombre);
            return true;
        }

        //  ELIMINAR (actualiza TRIE)
        public bool Eliminar(string ruta)
        {
            Nodo? nodo = Buscar(ruta);

            if (nodo == null)
            {
                Console.WriteLine("No se puede eliminar: ruta no encontrada.");
                return false;
            }

            if (nodo == Raiz)
            {
                Console.WriteLine("No se puede eliminar la raíz.");
                return false;
            }

            nodo.Padre!.EliminarHijo(nodo);

            trie.Eliminar(nodo.Nombre, nodo); // QUITAR DE TRIE

            Console.WriteLine("Nodo eliminado: " + ruta);
            return true;
        }

        //  MOVER (actualiza TRIE INDIRECTAMENTE)
        public bool Mover(string origen, string destino)
        {
            Nodo? nodo = Buscar(origen);
            Nodo? destinoNodo = Buscar(destino);

            if (nodo == null || destinoNodo == null)
            {
                Console.WriteLine("No se puede mover: ruta inválida.");
                return false;
            }

            if (!destinoNodo.EsCarpeta())
            {
                Console.WriteLine("No se puede mover dentro de un archivo.");
                return false;
            }

            nodo.Padre!.EliminarHijo(nodo);
            destinoNodo.AgregarHijo(nodo);

            Console.WriteLine($"Nodo movido: {origen} -> {destino}");
            return true;
        }



        public bool Renombrar(string ruta, string nuevoNombre)
        {
            Nodo? nodo = Buscar(ruta);

            if (nodo == null)
            {
                Console.WriteLine("No se puede renombrar: ruta inválida.");
                return false;
            }

            if (nodo == Raiz)
            {
                Console.WriteLine("No se puede renombrar la raíz.");
                return false;
            }

            if (nodo.Padre!.Children.Exists(h => h.Nombre == nuevoNombre))
            {
                Console.WriteLine("Ya existe un nodo con ese nombre.");
                return false;
            }

            trie.Eliminar(nodo.Nombre, nodo);  // quitar viejo nombre
            nodo.Nombre = nuevoNombre;
            trie.Insertar(nuevoNombre, nodo);  // indexar nuevo nombre

            Console.WriteLine($"Renombrado correctamente: {ruta} -> {nuevoNombre}");
            return true;
        }

        //  TAMAÑO Y ALTURA
        public int Tamano() => Contar(Raiz);

        private int Contar(Nodo nodo)
        {
            int total = 1;
            foreach (var hijo in nodo.Children)
                total += Contar(hijo);
            return total;
        }

        public int Altura() => AlturaRec(Raiz);

        private int AlturaRec(Nodo nodo)
        {
            if (nodo.Children.Count == 0)
                return 1;

            int max = 0;
            foreach (var hijo in nodo.Children)
                max = Math.Max(max, AlturaRec(hijo));

            return 1 + max;
        }

        //  DÍA 5–6: BÚSQUEDA POR NOMBRE + AUTOCOMPLETADO
        public List<Nodo> BuscarNombre(string nombre)
        {
            return trie.BusquedaExacta(nombre);
        }

        public List<Nodo> Autocompletar(string prefijo)
        {
            return trie.Autocompletar(prefijo);
        }

        //       PERSISTENCIA JSON (DÍA 4)
        public void GuardarJSON(string rutaArchivo)
        {
            var opciones = new JsonSerializerOptions
            {
                WriteIndented = true
            };

            string json = JsonSerializer.Serialize(Raiz, opciones);
            File.WriteAllText(rutaArchivo, json);

            Console.WriteLine("Árbol guardado en JSON correctamente.");
        }

        public void CargarJSON(string rutaArchivo)
        {
            if (!File.Exists(rutaArchivo))
            {
                Console.WriteLine("No se encontró el archivo JSON.");
                return;
            }

            string json = File.ReadAllText(rutaArchivo);
            Nodo? nuevaRaiz = JsonSerializer.Deserialize<Nodo>(json);

            if (nuevaRaiz == null)
            {
                Console.WriteLine("Error al cargar el árbol desde JSON.");
                return;
            }

            this.Raiz = nuevaRaiz;

            ReasignarPadres(Raiz, null);

            // RECONSTRUIR TRIE COMPLETO DESDE EL ÁRBOL
            trie = new Trie();
            ReIndexarTrie(Raiz);

            Console.WriteLine("Árbol cargado correctamente desde JSON.");
        }

        private void ReIndexarTrie(Nodo nodo)
        {
            trie.Insertar(nodo.Nombre, nodo);

            foreach (var hijo in nodo.Children)
                ReIndexarTrie(hijo);
        }

        private void ReasignarPadres(Nodo nodo, Nodo? padre)
        {
            nodo.Padre = padre;

            foreach (var hijo in nodo.Children)
                ReasignarPadres(hijo, nodo);
        }
    }
}

// archivo nodo.cs sin ningun cambio
using System;
using System.Collections.Generic;
using System.Text.Json.Serialization;   

namespace ProyectoArboles
{
    public class Nodo
    {
        public string Id { get; set; }
        public string Nombre { get; set; }
        public string Tipo { get; set; }
        public string Contenido { get; set; }
        public List<Nodo> Children { get; set; }

        [JsonIgnore]  //evita ciclos
        public Nodo Padre { get; set; }

        public Nodo(string nombre, string tipo, string contenido = null, Nodo padre = null)
        {
            Id = Guid.NewGuid().ToString();
            Nombre = nombre;
            Tipo = tipo;
            Contenido = contenido;
            Children = new List<Nodo>();
            Padre = padre;
        }

        public override string ToString()
        {
            return $"<{Tipo.ToUpper()}: {Nombre} (ID: {Id.Substring(0, 8)})>";
        }

        public void AgregarHijo(Nodo hijo)
        {
            hijo.Padre = this;
            Children.Add(hijo);
        }

        public bool EliminarHijo(Nodo hijo)
        {
            if (Children.Contains(hijo))
            {
                Children.Remove(hijo);
                hijo.Padre = null;
                return true;
            }
            return false;
        }

        public bool EsCarpeta()
        {
            return Tipo == "carpeta";
        }
    }
}

//archivo trie.cs sin ningun cambio
using System;
using System.Collections.Generic;

namespace ProyectoArboles
{
    public class TrieNodo
    {
        public Dictionary<char, TrieNodo> Hijos = new Dictionary<char, TrieNodo>();
        public List<Nodo> Referencias = new List<Nodo>(); 
    }

    public class Trie
    {
        private TrieNodo raiz = new TrieNodo();

        // INSERTAR NOMBRE EN EL TRIE
        public void Insertar(string palabra, Nodo nodo)
        {
            TrieNodo actual = raiz;

            foreach (char c in palabra.ToLower())
            {
                if (!actual.Hijos.ContainsKey(c))
                    actual.Hijos[c] = new TrieNodo();

                actual = actual.Hijos[c];
            }

            actual.Referencias.Add(nodo);
        }

        // ELIMINAR UNA REFERENCIA (NO BORRA SUBÁRBOLES)
        public void Eliminar(string palabra, Nodo nodo)
        {
            TrieNodo actual = raiz;

            foreach (char c in palabra.ToLower())
            {
                if (!actual.Hijos.ContainsKey(c))
                    return; // No existe, nada que eliminar

                actual = actual.Hijos[c];
            }

            actual.Referencias.Remove(nodo);
        }

        // BÚSQUEDA EXACTA
        public List<Nodo> BusquedaExacta(string palabra)
        {
            TrieNodo actual = raiz;

            foreach (char c in palabra.ToLower())
            {
                if (!actual.Hijos.ContainsKey(c))
                    return new List<Nodo>(); // No existe

                actual = actual.Hijos[c];
            }

            return new List<Nodo>(actual.Referencias);
        }

        // AUTOCOMPLETADO       
        public List<Nodo> Autocompletar(string prefijo)
        {
            TrieNodo actual = raiz;

            foreach (char c in prefijo.ToLower())
            {
                if (!actual.Hijos.ContainsKey(c))
                    return new List<Nodo>();

                actual = actual.Hijos[c];
            }

            List<Nodo> resultados = new List<Nodo>();
            RecolectarNodos(actual, resultados);
            return resultados;
        }

        private void RecolectarNodos(TrieNodo nodo, List<Nodo> lista)
        {
            lista.AddRange(nodo.Referencias);

            foreach (var hijo in nodo.Hijos.Values)
                RecolectarNodos(hijo, lista);
        }
    }
}

// archivo program.cs actulizado ya no se necesita el archivo pruebas.cs
using ProyectoArboles;

class Program
{
    static void Main()
    {
        Arbol arbol = new Arbol();
        Trie trie = new Trie();

        Consola consola = new Consola(arbol, trie);
        consola.Iniciar();
    }
}

